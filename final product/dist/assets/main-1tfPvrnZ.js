import{initializeApp as Z}from"https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";import{getFirestore as G,setDoc as N,doc as j,getDocs as F,collection as P,getDoc as re,addDoc as le}from"https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";import{getAuth as x,onAuthStateChanged as z,signOut as K,signInWithEmailAndPassword as J,createUserWithEmailAndPassword as W}from"https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))a(n);new MutationObserver(n=>{for(const s of n)if(s.type==="childList")for(const l of s.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&a(l)}).observe(document,{childList:!0,subtree:!0});function o(n){const s={};return n.integrity&&(s.integrity=n.integrity),n.referrerPolicy&&(s.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?s.credentials="include":n.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function a(n){if(n.ep)return;n.ep=!0;const s=o(n);fetch(n.href,s)}})();const de={apiKey:"AIzaSyB9EKMnm56WYp4Z3-wl9ACjt075sVPtcRk",authDomain:"trilobyte-4467e.firebaseapp.com",projectId:"trilobyte-4467e",storageBucket:"trilobyte-4467e.firebasestorage.app",messagingSenderId:"274511927374",appId:"1:274511927374:web:ff12db499028d8250b4b1f"},Y=Z(de),M=G(Y),B=x(Y),{auth:ce,db:S,collection:_,getDocs:Re,doc:v,onAuthStateChanged:U,getDoc:O,setDoc:ue}=window.firebase||{};window.firebase||console.error("Firebase not initialized. Ensure Firebase scripts load before this module.");const w=window.fishList,L=window.fishCaught;window.fishCaught=window.fishCaught||{};window.fishList=window.fishList||{dublinBayPrawm:{name:"Dublin Bay Prawn",description:"insert description",image:"/assets/game_assets/dublin-bay-prawn_64.png",chance:.5,uncaptureRate:1.5,pointValue:10,captureRateMult:3,feistynessMult:.5,wiggleStrength:.2,lungeChance:0},atlanticCod:{name:"Atlantic Cod",description:"insert description",image:"/assets/game_assets/atlantic-cod_128.png",chance:.5,uncaptureRate:1.5,pointValue:50},commonOctopus:{name:"Common Octopus",description:"insert description",image:"/assets/game_assets/common-octopus_128.png",chance:.5,uncaptureRate:1.5,pointValue:120,wiggleStrength:.3,feistynessMult:.5},brownCrab:{name:"Brown Crab",description:"insert description",image:"/assets/game_assets/crab_128.png",chance:.5,uncaptureRate:1.5,pointValue:40,wiggleStrength:0,edgeRepel:.01,gravity:.04,lungeChance:.015,lungePower:2.4,drag:.05,lungeIsJump:!0},goldFish:{name:"The Gold Fish",description:"missing description has been replaced by the description of the default fish",image:"/assets/game_assets/the-gold-fish_128.png",baseChance:.1,pointValue:1e3,wiggleStrength:.4,gravity:0,feistynessMult:6,edgeRepel:.3,captureRateMult:.3,lungeChance:.01,lungePower:0,lungeIsJump:!1,drag:.1}};function q(){const t=document.getElementById("upload-section");if(!t)return;let e=null,o="",a="";async function n(){try{if(!e)return;const i=v(S,"users",e.uid),u=v(_(i,"playerData"),"profile"),p=await O(u),f=document.getElementById("data-display");if(!f){console.error("Data display element not found in the DOM");return}if(!p.exists())f.innerHTML="<p>No data found for this user.</p>";else{const h=p.data();let E=`
          <strong>Username:</strong> ${h.name||"N/A"}<br />
          <strong>Total Score:</strong> ${h.totalscore||0}<br />
          <strong>Total Fish:</strong> ${h.totalfish||0}<br />
          <strong>Fish Caught:</strong><br />
        `;for(const se in w){const D=w[se].name,ie=h.fishCaught&&h.fishCaught[D]?h.fishCaught[D]:0;E+=`<strong>${D}:</strong> ${ie}<br>`}f.innerHTML=E,Object.assign(window.fishCaught,h.fishCaught)}}catch(i){console.error("Error loading data from Firestore:",i),t.querySelector("#data-display").innerHTML=`<p>Failed to load data: ${i.message}</p>`}}async function s(){try{const i={};for(const h in w){const E=w[h].name;i[E]=L[E]||0}const u={name:o,email:a,totalscore:c(),totalfish:ae(),fishCaught:i};if(window.jsonData=u,!e){console.error("No user signed in; cannot save data.");return}const p=v(S,"users",e.uid),f=v(_(p,"playerData"),"profile");await ue(f,window.jsonData,{merge:!0}),console.log("Game Data saved to Firebase!")}catch(i){console.error("Save failed:",i),alert("Failed to save game data: "+i.message)}}function l(){if(!e){t.innerHTML=`
        <p>Please <a href="#" id="upload-login-link">sign in</a> to save or load data.</p>
      `;const u=document.getElementById("upload-login-link");u&&u.addEventListener("click",p=>{p.preventDefault(),window.history.pushState({},"","/login"),window.renderPage()});return}t.innerHTML=`
      <div class="upload-json">
        <h2>Profile</h2>
        <div id="data-display">Loading data...</div>
        <button id="save-button">Save Data</button>
      </div>
    `;const i=document.getElementById("save-button");i&&i.addEventListener("click",async()=>{await s()}),n()}const g=new Proxy(window.fishCaught,{set(i,u,p){return i[u]=p,e&&s(),!0}});window.fishCaught=g,U?U(ce,async i=>{if(e=i,e){const u=v(S,"users",e.uid),p=await O(u);if(p.exists()){const f=p.data();o=f.username||"Unknown",a=f.email||e.email||"Unknown"}else console.error("User document not found in Firestore"),o="Unknown",a=e.email||"Unknown"}l()}):console.error("onAuthStateChanged not available. Firebase initialization failed.");function c(){let i=0;for(const u in w){const p=w[u].name,f=w[u].pointValue||0,h=L[p]||0;i+=h*f}return i}function ae(){let i=0;for(const u in L)i+=L[u]||0;return i}}function H(){const t=document.getElementById("login-link");t&&t.addEventListener("click",s=>{s.preventDefault(),window.history.pushState({},"","/login"),renderPage()});const e=document.getElementById("game-link");e&&e.addEventListener("click",s=>{s.preventDefault(),window.history.pushState({},"","/game"),renderPage()});const o=document.getElementById("leaderboard-link");o&&o.addEventListener("click",s=>{s.preventDefault(),window.history.pushState({},"","/leaderboard"),renderPage()});const a=document.getElementById("signout-button");a&&(z(B,s=>{s?a.style.display="inline-block":(a.style.display="none",window.history.pushState({},"","/login"),renderPage())}),a.addEventListener("click",async()=>{try{await K(B),alert("Signed out successfully!"),window.history.pushState({},"","/login"),renderPage()}catch(s){console.error("Sign out failed:",s),alert("Sign out failed: "+s.message)}}));const n=()=>{document.getElementById("upload-section")?q():(console.log("Waiting for upload-section to be available..."),setTimeout(n,100))};n()}async function ge(){const t=document.getElementById("app");try{const n=await fetch("/pages/login.html");if(!n.ok)throw new Error("Failed to load login.html");t.innerHTML=await n.text()}catch(n){console.error("Error loading login template:",n),t.innerHTML="<p>Error loading login page.</p>";return}const e=document.getElementById("login-form");e&&e.addEventListener("submit",async n=>{n.preventDefault();const s=document.getElementById("email").value,l=document.getElementById("password").value;if(!s||!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(s)){alert("Please enter a valid email address.");return}if(!l||l.length<6){alert("Password must be at least 6 characters long.");return}try{await J(B,s,l),alert("Logged in successfully!"),window.history.pushState({},"","/"),renderPage()}catch(g){console.error("Login error:",g);let c="An unexpected error occurred during login.";switch(g.code){case"auth/user-not-found":c="No user found with this email.";break;case"auth/wrong-password":c="Incorrect password.";break;case"auth/invalid-email":c="Invalid email format.";break;default:c=g.message}alert("Login failed: "+c)}});const o=document.getElementById("signup-link");o&&o.addEventListener("click",n=>{n.preventDefault(),window.history.pushState({},"","/signUp"),window.renderPage()});const a=document.getElementById("back-link");a?a.addEventListener("click",n=>{n.preventDefault(),window.history.pushState({},"","/"),renderPage()}):console.error("Back link not found in the DOM")}async function pe(){const t=document.getElementById("app");try{const a=await fetch("/pages/signUp.html");if(!a.ok)throw new Error("Failed to load signUp.html");t.innerHTML=await a.text()}catch(a){console.error("Error loading sign-up template:",a),t.innerHTML="<p>Error loading sign-up page.</p>";return}const e=document.getElementById("signup-form");e?e.addEventListener("submit",async a=>{a.preventDefault();const n=document.getElementById("signup-username").value.trim(),s=document.getElementById("signup-email").value.trim(),l=document.getElementById("signup-password").value;if(!n||n.length<3){alert("Username must be at least 3 characters long.");return}if(!s||!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(s)){alert("Please enter a valid email address.");return}if(!l||l.length<6){alert("Password must be at least 6 characters long.");return}try{const c=(await W(B,s,l)).user;await N(j(M,"users",c.uid),{username:n,email:s,createdAt:new Date().toISOString()}),alert("Sign up successful! You are now logged in."),window.history.pushState({},"","/"),window.renderPage()}catch(g){console.error("Sign up error:",g);let c="An unexpected error occurred during sign up.";switch(g.code){case"auth/email-already-in-use":c="This email is already in use. Please use a different email.";break;case"auth/invalid-email":c="Invalid email format.";break;case"auth/weak-password":c="Password is too weak. It must be at least 6 characters long.";break;default:c=g.message}alert("Sign up failed: "+c)}}):console.error('Signup form not found in the DOM. Ensure signUp.html includes <form id="signup-form">.');const o=document.getElementById("back-link");o?o.addEventListener("click",a=>{a.preventDefault(),window.history.pushState({},"","/"),window.renderPage()}):console.error('Back link not found in the DOM. Ensure signUp.html includes <a id="back-link">.')}async function he(){if(!document.getElementById("leaderboard-body")){document.getElementById("app").innerHTML="<p>Error: Leaderboard body not found.</p>";return}const e=document.getElementById("back-link");e&&e.addEventListener("click",o=>{o.preventDefault(),window.history.pushState({},"","/"),renderPage()}),await fe()}async function fe(){try{const t=document.getElementById("leaderboard-body");t.innerHTML='<tr><td colspan="8">Loading...</td></tr>';const e=await F(P(M,"users"));let o=[];for(const a of e.docs){const n=a.id;(await F(P(M,"users",n,"playerData"))).forEach(l=>{const g=l.data();o.push({name:g.name||"Unknown",totalscore:g.totalscore||0,totalfish:g.totalfish||0})})}if(o.sort((a,n)=>n.totalscore-a.totalscore),o.length===0){t.innerHTML='<tr><td colspan="8">No players found.</td></tr>';return}t.innerHTML="",o.forEach((a,n)=>{const s=document.createElement("tr");s.innerHTML=`
        <td>${n+1}</td>
        <td>${a.name}</td>
        <td>${a.totalscore}</td>
        <td>${a.totalfish}</td>
      `,t.appendChild(s)})}catch(t){console.error("Error fetching leaderboard data:",t);const e=document.getElementById("leaderboard-body");e&&(e.innerHTML='<tr><td colspan="8">Error loading leaderboard: '+t.message+"</td></tr>")}}const me=60,ye=.02,R={name:"Default Fish",description:"missing description has been replaced by the description of the default fish",image:"assets/game_assets/fish.png",baseChance:0,pointValue:1,wiggleStrength:.1,gravity:0,feistynessMult:1.1,edgeRepel:.1,captureRateMult:1,lungeChance:.01,lungePower:1,lungeIsJump:!1,drag:.01};let C=new Audio("/assets/game_assets/catchSuccess.wav"),I=new Audio("/assets/game_assets/catchFail.wav"),A=!1,Q=.5,we=!1,y=!1,be=15,m=0,r={y:0,dy:2,h:5},d={y:0,dy:2,h:be},b={};window.fishList=window.fishList||{dublinBayPrawm:{name:"Dublin Bay Prawn",description:"insert description",image:"/assets/game_assets/dublin-bay-prawn_64.png",baseChance:150,pointValue:10,captureRateMult:3,feistynessMult:.5,wiggleStrength:.2,lungeChance:0},atlanticCod:{name:"Atlantic Cod",description:"insert description",image:"/assets/game_assets/atlantic-cod_128.png",baseChance:100,pointValue:50},commonOctopus:{name:"Common Octopus",description:"insert description",image:"/assets/game_assets/common-octopus_128.png",baseChance:20,pointValue:120,wiggleStrength:.3,feistynessMult:.5},brownCrab:{name:"Brown Crab",description:"insert description",image:"/assets/game_assets/crab_128.png",baseChance:50,pointValue:40,wiggleStrength:0,edgeRepel:.01,gravity:.04,lungeChance:.015,lungePower:2.4,drag:.05,lungeIsJump:!0},goldFish:{name:"The Gold Fish",description:"missing description has been replaced by the description of the default fish",image:"/assets/game_assets/the-gold-fish_128.png",baseChance:.1,pointValue:1e3,wiggleStrength:.4,gravity:0,feistynessMult:6,edgeRepel:.3,captureRateMult:.3,lungeChance:.01,lungePower:0,lungeIsJump:!1,drag:.1}};window.fishCaught=window.fishCaught||{};function k(t,e){return Math.floor(Math.random()*e)+t}function X(){let t=0;for(let o in fishList)t+=fishList[o].baseChance??0;let e=k(0,t);console.log(e);for(let o in fishList){if(e<fishList[o].baseChance)return fishList[o];e-=fishList[o].baseChance??0,console.log("%d",e)}return console.error("Something went wrong when selecting a fish by chance"),R}function Ee(){te(X()),setInterval(Be,1e3/me)}function ee(){r.y=k(0,100),r.dy=0,m=30,te(X())}function te(t){b={};for(const e in R)b[e]=R[e];for(const e in t)b[e]=t[e];document.getElementById("fishGraphic").src=b.image}function ve(){var t;fishCaught[t=b.name]??(fishCaught[t]=0),fishCaught[b.name]+=1,A&&(C.volume=Q,C.playbackRate=k(80,120)/100,C.play()),ee()}function Le(){A&&(I.volume=Q,I.playbackRate=k(80,120)/100,I.play()),ee()}function Be(){console.log("gameloop running, paused:",we,"reeling:",y,"captureProgress:",m),y&&(d.dy=Math.min(1,d.dy+.1)),ke(),De(),m>=100?ve():m<1&&Le()}function ke(){r.dy-=ye,r.y+=r.dy,r.y<0?(r.y=0,r.dy=0):r.y>90&&(r.y=90,r.dy=0),console.log("fishZone physics: y =",r.y,"dy =",r.dy),y&&(d.y+=d.dy,d.y>90&&(d.y=90),d.y<0&&(d.y=0)),console.log("captureZone physics: y =",d.y,"dy =",d.dy),y&&r.y>=d.y&&r.y<=d.y+d.h?m+=1:m-=b.uncaptureRate,m<0&&(m=0)}function De(){const t=document.getElementById("fishZone");t?(t.style.bottom=r.y+"%",t.style.height=r.h+"%",console.log("fishZone updated: bottom =",r.y,"height =",r.h)):console.log("fishZoneElement is null");const e=document.getElementById("fishGraphic");e?(e.style.transform=`rotate(${10*r.dy}deg)`,console.log("fishGraphic rotated:",10*r.dy)):console.log("fishGraphicElement is null");const o=document.getElementById("captureZone");o?(o.style.bottom=d.y+"%",o.style.height=d.h+"%",console.log("captureZone updated: bottom =",d.y,"height =",d.h)):console.log("captureZoneElement is null");const a=document.getElementById("progressBar");a?(a.style.height=m+"%",console.log("progressBar updated: height =",m)):console.log("progressBar is null");const n=document.getElementById("sideBar");if(!n)console.log("sideBarElement is null");else{let s="";for(let l in fishCaught)s+=l+": "+fishCaught[l]+"<br>";n.innerHTML=s,console.log("sideBar updated:",s)}}function ne(){console.log("renderFishGame called");const t=document.getElementById("back-link");t?(console.log("Back link found, adding listener"),t.addEventListener("click",n=>{n.preventDefault(),window.history.pushState({},"","/"),window.renderPage()})):console.log("Back link not found");const e=document.body,o=document.getElementById("gameUIContainer"),a=document.getElementById("fishGraphic");e?(console.log("Body found, adding listeners"),e.addEventListener("mousedown",T),e.addEventListener("mouseup",$),e.addEventListener("contextmenu",V),e.addEventListener("click",()=>{A=!0,console.log("Sound enabled")})):console.log("Body not found"),o?(console.log("Game container found, adding listeners"),o.addEventListener("mousedown",T),o.addEventListener("mouseup",$)):console.log("Game container not found"),a?(console.log("Fish graphic found"),a.addEventListener("contextmenu",V)):console.log("Fish graphic not found"),console.log("Body found, adding listeners"),document.getElementById("fishZone")?(console.log("DOM ready, starting init"),Ee()):(console.log("DOM not ready, waiting..."),setTimeout(()=>ne(),100))}function T(t){t.preventDefault(),y=!0,console.log("startReel: reeling =",y)}function $(t){t.preventDefault(),y=!1,console.log("stopReel: reeling =",y)}window.startReel=T;window.stopReel=$;function V(t){t.preventDefault()}console.log("main.js loaded");console.log("Imports completed");const Se={apiKey:"AIzaSyB9EKMnm56WYp4Z3-wl9ACjt075sVPtcRk",authDomain:"trilobyte-4467e.firebaseapp.com",projectId:"trilobyte-4467e",storageBucket:"trilobyte-4467e.firebasestorage.app",messagingSenderId:"274511927374",appId:"1:274511927374:web:ff12db499028d8250b4b1f"};console.log("Firebase initialized in main.js:",window.firebase);const oe=Z(Se),Ce=G(oe),Ie=x(oe);window.firebase={db:Ce,collection:P,addDoc:le,getDocs:F,doc:j,setDoc:N,getDoc:re,auth:Ie,signInWithEmailAndPassword:J,createUserWithEmailAndPassword:W,onAuthStateChanged:z,signOut:K};console.log("Firebase initialized in main.js:",window.firebase);window.renderPage=async()=>{console.log("renderPage called, pathname:",window.location.pathname);const t=window.location.pathname,e=document.getElementById("app");if(!e){console.error("App element not found");return}let o="";t==="/"||t===""?(o="/pages/welcome.html",initFunction=H):t==="/login"?(o="/pages/login.html",initFunction=ge):t==="/signUp"?(o="/pages/signUp.html",initFunction=pe):t==="/game"?o="/pages/game.html":t==="/leaderboard"?(o="/pages/leaderboard.html",initFunction=he):(window.history.pushState({},"","/"),o="/pages/welcome.html",initFunction=H);try{console.log("Fetching:",o);const a=await fetch(o,{cache:"no-store"});if(!a.ok)throw new Error(`Failed to load ${o}: ${a.status} ${a.statusText}`);const n=await a.text();e.innerHTML=n,console.log("Page loaded:",o),t==="/game"&&(console.log("Initializing game page"),ne(),q())}catch(a){console.error("Error loading page:",a),e.innerHTML="<p>Error loading page. Please try again.</p>"}};console.log("Calling renderPage");window.renderPage();window.addEventListener("popstate",window.renderPage);
